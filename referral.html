<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrix History | RebirthKey</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --gold: #ffd700; --bg-dark: #060a08; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg-dark); color: white; 
            background-image: radial-gradient(circle at 50% 0%, #1a2e23, #060a08 80%);
            min-height: 100vh;
        }
        .orbitron { font-family: 'Orbitron', sans-serif; }
        
        .matrix-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 215, 0, 0.1);
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .matrix-card:hover {
            border-color: var(--gold);
            background: rgba(255, 215, 0, 0.05);
            transform: translateY(-5px);
        }

        .slot-circle {
            width: 12px; height: 12px;
            border-radius: 50%;
            background: #222;
        }
        .slot-filled {
            background: var(--gold);
            box-shadow: 0 0 10px var(--gold);
        }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="pb-24">

    <div id="header-placeholder"></div>
    <div id="nav-placeholder"></div>

    <main class="max-w-6xl mx-auto px-4 pt-10">
        
        <div class="flex flex-col md:flex-row justify-between items-end gap-6 mb-10">
            <div>
                <h3 class="orbitron font-black text-2xl text-white border-l-4 border-yellow-500 pl-4 uppercase">Matrix <span class="text-yellow-500">History</span></h3>
                <p class="text-[10px] text-gray-500 font-bold ml-5 mt-1 tracking-widest uppercase">All Rebirth Node Status</p>
            </div>
            
            <div class="flex gap-4 w-full md:w-auto">
                <div class="flex-grow md:w-48">
                    <p class="text-[9px] text-gray-500 uppercase font-black mb-2">Select Package</p>
                    <select id="pkg-selector" onchange="loadMatrixHistory()" class="w-full bg-black border border-yellow-500/30 text-yellow-500 text-xs p-2 rounded-lg outline-none">
                        <option value="0">Package $5</option>
                        <option value="1">Package $44</option>
                        <option value="2">Package $65</option>
                        <option value="3">Package $106</option>
                        <option value="4">Package $187</option>
                        <option value="5">Package $348</option>
                        <option value="6">Package $669</option>
                        <option value="7">Package $1310</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="history-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

    </main>

    <div id="footer-placeholder"></div>

    <script src="components.js"></script>
    <script src="web3-handler.js"></script>
    <script>
        lucide.createIcons();
        let myAddress = "";

        async function initPage() {
            if(!window.signer) {
                setTimeout(initPage, 1000);
                return;
            }
            myAddress = await window.signer.getAddress();
            loadMatrixHistory();
        }

        async function loadMatrixHistory() {
            const pkgId = document.getElementById('pkg-selector').value;
            const grid = document.getElementById('history-grid');
            
            grid.innerHTML = `
                <div class="col-span-full text-center py-20 opacity-50">
                    <i data-lucide="loader-2" class="w-10 h-10 animate-spin mx-auto mb-4 text-yellow-500"></i>
                    <p class="orbitron text-xs text-yellow-500">Scanning Blockchain Data...</p>
                </div>`;
            lucide.createIcons();

            try {
                const history = await window.getAllMatrixHistory(myAddress, pkgId);
                console.log("Rendering History Array:", history);

                grid.innerHTML = "";

                if(!history || history.length === 0) {
                    grid.innerHTML = `<div class="col-span-full text-center py-20 bg-black/40 rounded-3xl border border-dashed border-gray-800">
                        <p class="text-gray-500 orbitron text-xs uppercase">No History Found</p>
                    </div>`;
                    return;
                }

                // Render Newest to Oldest
                history.forEach((node, index) => {
                    // --- 100% Robust Mapping ---
                    // Contract se aane wala data ya toh object hota hai ya array
                    const idx = node.index !== undefined ? node.index : (node[0] !== undefined ? node[0] : index);
                    
                    // Filled count ko string mein badal kar parse karna takki BigNumber handle ho jaye
                    let rawCount = node.filledCount !== undefined ? node.filledCount : (node[1] !== undefined ? node[1] : 0);
                    const count = parseInt(rawCount.toString());

                    const sA = node.slotA || node[2] || "0x0000000000000000000000000000000000000000";
                    const sB = node.slotB || node[3] || "0x0000000000000000000000000000000000000000";
                    const sC = node.slotC || node[4] || "0x0000000000000000000000000000000000000000";

                    const isComplete = count >= 3;
                    // Last element in array is the newest/active one if not complete
                    const isActuallyActive = (index === history.length - 1) && !isComplete;
                    const displayIdx = parseInt(idx.toString()) + 1;

                    const card = document.createElement('div');
                    card.className = `matrix-card p-6 ${isActuallyActive ? 'border-yellow-500/50 bg-yellow-500/10' : ''}`;
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <span class="text-[10px] ${isActuallyActive ? 'text-yellow-500' : 'text-gray-500'} font-black orbitron uppercase">
                                    ${isActuallyActive ? 'Active Cycle' : 'Matrix Node'}
                                </span>
                                <h4 class="text-xl font-black orbitron">#${displayIdx}</h4>
                            </div>
                            <div class="text-right">
                                <span class="text-[10px] text-gray-500 font-black orbitron uppercase">Progress</span>
                                <p class="text-[10px] font-bold ${isComplete ? 'text-green-500' : 'text-blue-400'}">
                                    ${count}/3 Filled
                                </p>
                            </div>
                        </div>

                        <div class="space-y-4">
                            ${renderSlot("Slot A", sA)}
                            ${renderSlot("Slot B", sB)}
                            ${renderSlot("Slot C", sC)}
                        </div>

                        <div class="mt-6 pt-4 border-t border-white/5 flex justify-between items-center">
                            <span class="text-[9px] font-bold uppercase italic ${isActuallyActive ? 'text-yellow-500' : 'text-gray-600'}">
                                ${isActuallyActive ? 'Current Active Node' : 'Closed Rebirth'}
                            </span>
                            <div class="flex items-center gap-2">
                                <span class="text-[8px] font-bold ${isComplete ? 'text-green-500' : (isActuallyActive ? 'text-yellow-500' : 'text-gray-600')}">
                                    ${isComplete ? 'COMPLETED' : (isActuallyActive ? 'IN PROGRESS' : 'CLOSED')}
                                </span>
                                <i data-lucide="${isComplete ? 'check-circle-2' : (isActuallyActive ? 'refresh-cw' : 'lock')}" 
                                   class="w-4 h-4 ${isComplete ? 'text-green-500' : (isActuallyActive ? 'text-yellow-500 animate-spin-slow' : 'text-gray-600')}"></i>
                            </div>
                        </div>
                    `;
                    grid.prepend(card);
                });

                lucide.createIcons();
            } catch(e) {
                console.error("UI Render Error:", e);
                grid.innerHTML = `<p class="text-red-500 text-center col-span-full py-10">Render Error. Check Console.</p>`;
            }
        }

        function renderSlot(label, addr) {
            // Address check for zero address
            const isFilled = addr && 
                             addr !== "0x0000000000000000000000000000000000000000" && 
                             addr.toLowerCase() !== "0x0000000000000000000000000000000000000000";
            
            return `
                <div class="flex items-center gap-3 bg-black/40 p-3 rounded-xl border ${isFilled ? 'border-yellow-500/20' : 'border-white/5'}">
                    <div class="slot-circle ${isFilled ? 'slot-filled' : ''}"></div>
                    <div class="flex-grow">
                        <p class="text-[8px] text-gray-500 font-black uppercase">${label}</p>
                        <p class="text-[10px] font-mono ${isFilled ? 'text-yellow-500' : 'text-gray-700'}">
                            ${isFilled ? addr.substring(0,10)+"..."+addr.substring(addr.length - 4) : 'Awaiting Spillover...'}
                        </p>
                    </div>
                </div>
            `;
        }

        window.addEventListener('load', initPage);
    </script>
</body>
</html>
