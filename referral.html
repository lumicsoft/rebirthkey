<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrix History | RebirthKey</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --gold: #ffd700; --bg-dark: #060a08; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg-dark); color: white; 
            background-image: radial-gradient(circle at 50% 0%, #1a2e23, #060a08 80%);
            min-height: 100vh;
        }
        .orbitron { font-family: 'Orbitron', sans-serif; }
        
        .gold-border-fixed {
            background: rgba(0,0,0,0.6);
            border: 1.5px solid var(--gold);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.1);
            border-radius: 24px;
        }

        .matrix-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 215, 0, 0.1);
            border-radius: 20px;
            transition: transform 0.3s ease;
        }

        .matrix-card:hover {
            border-color: var(--gold);
            background: rgba(255, 215, 0, 0.05);
            transform: translateY(-5px);
        }

        .slot-circle {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #222;
        }
        .slot-filled {
            background: var(--gold);
            box-shadow: 0 0 10px var(--gold);
        }
    </style>
</head>
<body class="pb-24">

    <div id="header-placeholder"></div>
    <div id="nav-placeholder"></div>

    <main class="max-w-6xl mx-auto px-4 pt-10">
        
        <div class="flex flex-col md:flex-row justify-between items-end gap-6 mb-10">
            <div>
                <h3 class="orbitron font-black text-2xl text-white border-l-4 border-yellow-500 pl-4 uppercase">Matrix <span class="text-yellow-500">History</span></h3>
                <p class="text-[10px] text-gray-500 font-bold ml-5 mt-1 tracking-widest uppercase">All Rebirth Node Status</p>
            </div>
            
            <div class="flex gap-4 w-full md:w-auto">
                <div class="flex-grow md:w-48">
                    <p class="text-[9px] text-gray-500 uppercase font-black mb-2">Select Package</p>
                    <select id="pkg-selector" onchange="loadMatrixHistory()" class="w-full bg-black border border-yellow-500/30 text-yellow-500 text-xs p-2 rounded-lg outline-none">
                        <option value="0">Package $5</option>
                        <option value="1">Package $44</option>
                        <option value="2">Package $65</option>
                        <option value="3">Package $106</option>
                        <option value="4">Package $187</option>
                        <option value="5">Package $348</option>
                        <option value="6">Package $669</option>
                        <option value="7">Package $1310</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="history-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="col-span-full text-center py-20 opacity-50">
                <i data-lucide="loader-2" class="w-10 h-10 animate-spin mx-auto mb-4 text-yellow-500"></i>
                <p class="orbitron text-xs text-yellow-500">Fetching Matrix History...</p>
            </div>
        </div>

    </main>

    <div id="footer-placeholder"></div>

    <script src="components.js"></script>
    <script src="web3-handler.js"></script>
    <script>
        lucide.createIcons();
        let myAddress = "";

        async function initPage() {
            // Wait for web3 connection
            if(!window.signer) {
                setTimeout(initPage, 1000);
                return;
            }
            myAddress = await window.signer.getAddress();
            loadMatrixHistory();
        }

       async function loadMatrixHistory() {
    const pkgId = document.getElementById('pkg-selector').value;
    const grid = document.getElementById('history-grid');
    
    // 1. Loading State
    grid.innerHTML = `
        <div class="col-span-full text-center py-20 opacity-50">
            <i data-lucide="loader-2" class="w-10 h-10 animate-spin mx-auto mb-4 text-yellow-500"></i>
            <p class="orbitron text-xs text-yellow-500">Syncing with Blockchain...</p>
        </div>`;
    lucide.createIcons();

    try {
        // Contract se array fetch kar rahe hain
        // Expected Response: [ ["index", "filledCount", "slotA", "slotB", "slotC"], [...] ]
        const history = await window.getAllMatrixHistory(myAddress, pkgId);
        
        grid.innerHTML = "";

        if(!history || history.length === 0) {
            grid.innerHTML = `
                <div class="col-span-full text-center py-20 bg-black/40 rounded-3xl border border-dashed border-gray-800">
                    <p class="text-gray-500 orbitron text-xs uppercase tracking-widest">No Rebirth History Found</p>
                </div>`;
            return;
        }

        // 2. Loop through all nodes
        // Latest data pehle dikhane ke liye reverse loop
        for(let i = history.length - 1; i >= 0; i--) {
            const node = history[i];
            
            // --- DATA MAPPING (BASED ON YOUR CONTRACT RESPONSE) ---
            const rawIndex = node[0];    // Index
            const filledCount = node[1]; // Filled Count
            const sA = node[2];          // Slot A
            const sB = node[3];          // Slot B
            const sC = node[4];          // Slot C

            const card = document.createElement('div');
            card.className = "matrix-card p-6";
            
            // Fix: Dashboard Match Index (+1)
            const displayIndex = parseInt(rawIndex) + 1;
            
            // Check if node is complete
            const isComplete = parseInt(filledCount) >= 3;

            card.innerHTML = `
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <span class="text-[10px] text-yellow-500 font-black orbitron uppercase">Matrix Cycle</span>
                        <h4 class="text-xl font-black orbitron">#${displayIndex}</h4>
                    </div>
                    <div class="text-right">
                        <span class="text-[10px] text-gray-500 font-black orbitron uppercase">Progress</span>
                        <p class="text-[10px] font-bold ${isComplete ? 'text-green-500' : 'text-blue-400'}">
                            ${filledCount}/3 Slots
                        </p>
                    </div>
                </div>

                <div class="space-y-4">
                    ${renderSlot("Slot A", sA)}
                    ${renderSlot("Slot B", sB)}
                    ${renderSlot("Slot C", sC)}
                </div>

                <div class="mt-6 pt-4 border-t border-white/5 flex justify-between items-center">
                    <span class="text-[9px] text-gray-600 font-bold uppercase italic">
                        ${i === history.length - 1 ? 'Current Active Node' : 'Completed Cycle'}
                    </span>
                    <div class="flex items-center gap-2">
                        <span class="text-[8px] font-bold ${isComplete ? 'text-green-500' : 'text-yellow-500'}">
                            ${isComplete ? 'FILLED' : 'OPEN'}
                        </span>
                        <i data-lucide="${isComplete ? 'check-circle-2' : 'refresh-cw'}" 
                           class="w-4 h-4 ${isComplete ? 'text-green-500' : 'text-yellow-500 ${!isComplete ? 'animate-spin-slow' : ''}'}"></i>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        }
        lucide.createIcons();
    } catch(e) {
        console.error("Critical History Error:", e);
        grid.innerHTML = `<div class="col-span-full text-center text-red-500 p-10 bg-red-500/10 rounded-xl border border-red-500/20">
            <p class="orbitron text-xs">Blockchain Error: Data mapping failed or connection lost.</p>
        </div>`;
    }
}
        function renderSlot(label, addr) {
            const isFilled = addr !== "0x0000000000000000000000000000000000000000";
            return `
                <div class="flex items-center gap-3 bg-black/20 p-2 rounded-lg border border-white/5">
                    <div class="slot-circle ${isFilled ? 'slot-filled' : ''}"></div>
                    <div class="flex-grow">
                        <p class="text-[8px] text-gray-500 font-black uppercase">${label}</p>
                        <p class="text-[10px] font-mono ${isFilled ? 'text-white' : 'text-gray-700'}">
                            ${isFilled ? addr.substring(0,10)+"..."+addr.substring(32) : 'Awaiting Spillover...'}
                        </p>
                    </div>
                </div>
            `;
        }

        window.addEventListener('load', initPage);
    </script>
</body>
</html>
